# システムパターン

## 全体アーキテクチャ

### レイヤードアーキテクチャ

このプロジェクトでは、以下の層に分けたレイヤードアーキテクチャを採用しています：

```
┌─────────────────────────────────────┐
│       プレゼンテーション層          │
│  (ユーザーインターフェース、表示)   │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│         アプリケーション層          │
│    (ユースケース、調整、トランザクション)  │
└───────────────┬─────────────────────┘
                ↓
┌─────────────────────────────────────┐
│           ドメイン層               │
│    (ビジネスルール、エンティティ)   │
└───────────────┬─────────────────────┘
                ↑
┌─────────────────────────────────────┐
│       インフラストラクチャ層        │
│    (データアクセス、外部システム)   │
└─────────────────────────────────────┘
```

### 依存関係の方向

- 内側の層は外側の層に依存してはならない
- 依存関係は常に外側から内側へ向かう
- 外側の層から内側の層への依存は抽象（インターフェース）を通じて行う

## フロントエンドアーキテクチャ

### コンポーネント設計

#### アトミックデザイン

コンポーネントを以下の5つのレベルに分類：

1. **原子 (Atoms)**
   - ボタン、入力フィールド、ラベルなどの最小単位のコンポーネント
   - 他のコンポーネントに依存しない

2. **分子 (Molecules)**
   - 複数の原子を組み合わせた機能単位
   - 例：検索フォーム（入力フィールドとボタンの組み合わせ）

3. **有機体 (Organisms)**
   - 分子と原子を組み合わせた複雑なコンポーネント
   - 例：ヘッダー、フォーム、商品カードリストなど

4. **テンプレート (Templates)**
   - ページのレイアウト構造を定義
   - 実際のコンテンツではなく、コンポーネントの配置を示す

5. **ページ (Pages)**
   - テンプレートにデータを流し込んだ実際のページ
   - ルーティングの対象となる

#### コンポーネントの責務分離

- **表示コンポーネント (Presentational Components)**
  - 見た目に関する責務のみを持つ
  - プロップスを通じてデータを受け取り表示
  - 状態を持たない（または UI 状態のみ）
  - 再利用性が高い

- **コンテナコンポーネント (Container Components)**
  - データの取得や状態管理を担当
  - 表示コンポーネントにデータを渡す
  - ビジネスロジックを含む
  - 再利用性は低い

### 状態管理

#### グローバル状態
- アプリケーション全体で共有される状態
- 認証情報、テーマ設定、グローバル通知など
- Redux, MobX, Context API などを使用

#### ローカル状態
- 特定のコンポーネントやページに閉じた状態
- フォームの入力値、UI の開閉状態など
- React の useState, useReducer などを使用

## バックエンドアーキテクチャ

### API 設計

#### RESTful API 原則
- リソース指向の URL 設計
- 適切な HTTP メソッドの使用
- ステートレスな通信
- HATEOAS（Hypermedia as the Engine of Application State）の考慮

#### エンドポイント命名規則
- 名詞を使用し、複数形を基本とする
- `/api/v1/users`, `/api/v1/products` など
- 階層関係は `/api/v1/users/{id}/orders` のように表現
- 動詞は避け、HTTP メソッドで操作を表現

### データアクセス

#### リポジトリパターン
- データアクセスロジックをドメインロジックから分離
- インターフェースを通じた実装の抽象化
- テスト容易性の向上

```
┌─────────────────────┐      ┌─────────────────────┐
│   ドメインサービス   │ ←→  │  リポジトリインターフェース  │
└─────────────────────┘      └──────────┬──────────┘
                                        ↑
                             ┌──────────┴──────────┐
                             │  リポジトリ実装クラス  │
                             └──────────┬──────────┘
                                        ↓
                             ┌──────────┴──────────┐
                             │     データソース     │
                             └─────────────────────┘
```

#### O/R マッピング
- エンティティとデータベーステーブルのマッピング
- リレーションシップの適切な設計
- 遅延ロードと即時ロードの使い分け

### ビジネスロジック

#### ドメインサービス
- エンティティ単体では表現できないビジネスロジック
- 複数のエンティティにまたがる操作
- トランザクション境界の明確化

#### アプリケーションサービス
- ユースケースの実装
- トランザクション管理
- 認可チェック
- イベント発行

## クロスカッティングコンサーン

### ロギング
- 構造化ログの採用
- ログレベルの適切な使い分け
- コンテキスト情報の付加
- パフォーマンスへの配慮

### エラーハンドリング
- 例外の適切な粒度と種類
- グローバルエラーハンドラの実装
- エラーの適切な伝播
- ユーザーフレンドリーなエラーメッセージ

### 認証と認可
- JWT または OAuth 2.0 ベースの認証
- ロールベースのアクセス制御
- 認可チェックの一貫した実装
- セッション管理とトークン更新戦略

### キャッシュ戦略
- 複数レイヤーでのキャッシュ
- キャッシュの無効化ポリシー
- 分散キャッシュの考慮
- キャッシュヒット率の監視

## Docker環境構成

### 開発環境

```
┌─────────────────────────────────────────────────┐
│                Docker Compose                   │
│                                                 │
│  ┌─────────────────┐      ┌─────────────────┐  │
│  │      app        │      │       db        │  │
│  │  (Node.js/Express) │←→│    (PostgreSQL)   │  │
│  └─────────────────┘      └─────────────────┘  │
│                                                 │
└─────────────────────────────────────────────────┘
```

- 開発環境用のDockerfile (`docker/dev/Dockerfile`)
- ホットリロード対応
- ボリュームマウントによるコード変更の即時反映
- 環境変数による設定

### 本番環境

```
┌─────────────────────────────────────────────────┐
│                Docker Compose                   │
│                                                 │
│  ┌─────────────────┐      ┌─────────────────┐  │
│  │      app        │      │       db        │  │
│  │  (最適化されたビルド) │←→│  (永続ボリューム)  │  │
│  └─────────────────┘      └─────────────────┘  │
│                                                 │
└─────────────────────────────────────────────────┘
```

- 本番環境用のDockerfile (`docker/prod/Dockerfile`)
- マルチステージビルドによる最適化
- 環境変数による設定
- セキュリティ対策

## CI/CD パイプライン

### GitHub Actions ワークフロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    コード    │ →  │   ビルド    │ →  │   テスト    │
│   プッシュ   │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
┌─────────────┐     ┌─────────────┐           ↓
│   本番環境   │ ←  │  デプロイ   │ ←  ┌─────────────┐
│             │     │             │     │   品質     │
└─────────────┘     └─────────────┘     │  チェック   │
                                        └─────────────┘
```

- AWS デプロイワークフロー
- Vercel デプロイワークフロー
- Playwright テストワークフロー

## MCP サーバー構成

### GitHub MCP サーバー

```
┌─────────────────┐     ┌─────────────────┐
│      Cline      │ ←→ │  GitHub MCP     │
│                 │     │    サーバー      │
└─────────────────┘     └────────┬────────┘
                                 ↓
                        ┌─────────────────┐
                        │   GitHub API    │
                        │                 │
                        └─────────────────┘
```

- リポジトリ情報の取得
- イシューの作成・取得
- プルリクエストの作成・取得

### カスタム MCP サーバー開発

```
┌─────────────────┐     ┌─────────────────┐
│      Cline      │ ←→ │  カスタム MCP   │
│                 │     │    サーバー      │
└─────────────────┘     └────────┬────────┘
                                 ↓
                        ┌─────────────────┐
                        │   外部 API/     │
                        │   サービス      │
                        └─────────────────┘
```

- ツール定義
- リソース定義
- エラーハンドリング
- セキュリティ対策
